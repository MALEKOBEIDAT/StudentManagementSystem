@model StudentManagementSystem.Models.Student

@{
    ViewBag.Title = "Create Student";
}

<div ng-app="StudentApp" ng-controller="StudentController" class="container mt-5">

    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white text-center">
            <h2><i class="fas fa-user-graduate"></i> Create Student</h2>
        </div>

        <div class="card-body">
            <form name="createStudentForm" ng-submit="createStudent()" novalidate>

                <!-- Success and Error Messages -->
                <div class="alert alert-success" ng-if="successMessage">{{ successMessage }}</div>
                <div class="alert alert-danger" ng-if="errorMessage">{{ errorMessage }}</div>

                <!-- Student Number -->
                <div class="form-group">
                    <label for="studentNumber">Student Number</label>
                    <input type="text"
                           class="form-control"
                           name="studentNumber"
                           ng-model="student.StudentNumber"
                           ng-pattern="/^\d{8}$/"
                           required />
                    <small class="text-danger" ng-show="createStudentForm.studentNumber.$dirty && createStudentForm.studentNumber.$invalid">
                        <span ng-show="createStudentForm.studentNumber.$error.required">Student Number is required.</span>
                        <span ng-show="createStudentForm.studentNumber.$error.pattern">Student Number must be **exactly 8 digits**.</span>
                    </small>
                </div>

                <!-- Name Arabic -->
                <div class="form-group">
                    <label for="nameArabic">Name (Arabic)</label>
                    <input type="text"
                           class="form-control"
                           name="nameArabic"
                           ng-model="student.NameArabic"
                           ng-pattern="/^[\u0600-\u06FF ]+$/"
                           required />
                    <small class="text-danger" ng-show="createStudentForm.nameArabic.$dirty && createStudentForm.nameArabic.$invalid">
                        <span ng-show="createStudentForm.nameArabic.$error.required">Name (Arabic) is required.</span>
                        <span ng-show="createStudentForm.nameArabic.$error.pattern">Name (Arabic) must be in **Arabic letters only**.</span>
                    </small>
                </div>

                <!-- Name English -->
                <div class="form-group">
                    <label for="nameEnglish">Name (English)</label>
                    <input type="text"
                           class="form-control"
                           name="nameEnglish"
                           ng-model="student.NameEnglish"
                           ng-pattern="/^[A-Za-z ]+$/"
                           required />
                    <small class="text-danger" ng-show="createStudentForm.nameEnglish.$dirty && createStudentForm.nameEnglish.$invalid">
                        <span ng-show="createStudentForm.nameEnglish.$error.required">Name (English) is required.</span>
                        <span ng-show="createStudentForm.nameEnglish.$error.pattern">Name (English) must be in **English letters only**.</span>
                    </small>
                </div>

                <!-- Picture Upload -->
                <div class="form-group">
                    <label for="pictureFile">Upload Picture</label>
                    <input type="file"
                           class="form-control"
                           file-model="student.PictureFile"
                           accept="image/*"
                           required />
                    <small class="text-danger" ng-show="!student.PictureFile">Please upload a **valid image file** (jpg, png, etc.).</small>
                    <img ng-if="student.PictureFile" ng-src="{{picturePreview}}" class="img-thumbnail mt-2" width="150" height="150" />
                </div>



                <!-- Tawjehi Average -->
                <div class="form-group">
                    <label for="tawjehiAverage">Tawjehi Average</label>
                    <input type="number"
                           class="form-control"
                           name="tawjehiAverage"
                           ng-model="student.TawjehiAverage"
                           min="0"
                           max="100"
                           required />
                    <small class="text-danger" ng-show="createStudentForm.tawjehiAverage.$dirty && createStudentForm.tawjehiAverage.$invalid">
                        <span ng-show="createStudentForm.tawjehiAverage.$error.required">Tawjehi Average is required.</span>
                        <span ng-show="createStudentForm.tawjehiAverage.$error.min || createStudentForm.tawjehiAverage.$error.max">Tawjehi Average must be between 0 and 100.</span>
                    </small>
                </div>
                <!-- School Name -->
                <div class="form-group">
                    <label for="schoolName">School Name</label>
                    <input type="text"
                           class="form-control"
                           name="schoolName"
                           ng-model="student.SchoolName"
                           ng-pattern="/^[A-Za-z ]+$/"
                           required />
                    <small class="text-danger" ng-show="createStudentForm.schoolName.$dirty && createStudentForm.schoolName.$invalid">
                        <span ng-show="createStudentForm.schoolName.$error.required">School Name is required.</span>
                        <span ng-show="createStudentForm.schoolName.$error.pattern">School Name must be in **English letters only**.</span>

                    </small>
                </div>



                <!-- National Number -->
                <div class="form-group">
                    <label for="nationalNumber">National Number</label>
                    <input type="text"
                           class="form-control"
                           name="nationalNumber"
                           ng-model="student.NationalNumber"
                           ng-pattern="/^\d{10,12}$/"
                           required />
                    <small class="text-danger" ng-show="createStudentForm.nationalNumber.$dirty && createStudentForm.nationalNumber.$invalid">
                        <span ng-show="createStudentForm.nationalNumber.$error.required">National Number is required.</span>
                        <span ng-show="createStudentForm.nationalNumber.$error.pattern">National Number must be 10-12 digits.</span>
                    </small>
                </div>
                <div class="form-group">
                    <label for="physicsGrade">Physics Grade</label>
                    <input type="number"
                           class="form-control"
                           name="physicsGrade"
                           ng-model="student.PhysicsGrade"
                           min="0"
                           max="100"
                           required />
                    <small class="text-danger" ng-show="createStudentForm.physicsGrade.$dirty && createStudentForm.physicsGrade.$invalid">
                        <span ng-show="createStudentForm.physicsGrade.$error.required">Physics Grade is required.</span>
                        <span ng-show="createStudentForm.physicsGrade.$error.min || createStudentForm.physicsGrade.$error.max">Physics Grade must be between 0 and 100.</span>
                    </small>
                </div>




                <div class="form-group">
                    <label for="MathGrade">Math Grade</label>
                    <input type="number"
                           class="form-control"
                           name="MathGrade"
                           ng-model="student.MathGrade"
                           min="0"
                           max="100"
                           required />
                    <small class="text-danger" ng-show="createStudentForm.MathGrade.$dirty && createStudentForm.MathGrade.$invalid">
                        <span ng-show="createStudentForm.MathGrade.$error.required">MathGrade is required.</span>
                        <span ng-show="createStudentForm.MathGrade.$error.min || createStudentForm.MathGrade.$error.max">MathGrade  must be between 0 and 100.</span>
                    </small>
                </div>




                <!-- Date of Birth -->
                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="date"
                           class="form-control"
                           ng-model="student.DateOfBirth"
                           required />
                    <small class="text-danger" ng-show="createStudentForm.dateOfBirth.$invalid && createStudentForm.dateOfBirth.$touched">Date of Birth is required.</small>
                </div>
                <!-- Submit Button -->
                <div class="form-group text-center">
                    <button type="submit"
                            class="btn btn-success btn-block"
                            ng-disabled="isFormInvalid()"
                            tooltip="Please fill all required fields and upload an image.">
                        <i ng-if="loading" class="fas fa-spinner fa-spin"></i>
                        <span ng-if="!loading"><i class="fas fa-save"></i> Create Student</span>
                    </button>
                </div>

            </form>
        </div>
    </div>

</div>
<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Use only one version of jQuery -->
<!-- Include AngularJS -->
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script> <!-- Keep only one AngularJS import -->
<!-- Include Font Awesome -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

<!-- Include Bootstrap Bundle (includes Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Include CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">


<script>
    var app = angular.module('StudentApp', []);

    // File input directive for AngularJS
    app.directive('fileModel', ['$parse', function ($parse) {
        return {
            restrict: 'A',
            link: function (scope, element, attrs) {
                var model = $parse(attrs.fileModel);
                var modelSetter = model.assign;

                element.bind('change', function () {
                    scope.$apply(function () {
                        var file = element[0].files[0];
                        if (file && file.type.match('image.*')) {
                            modelSetter(scope, file);
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                scope.$apply(function () {
                                    scope.picturePreview = e.target.result;
                                });
                            };
                            reader.readAsDataURL(file);
                        } else {
                            alert('Please upload a valid image file (jpg, png, etc.)');
                            element.val(null);
                        }
                    });
                });
            }
        };
    }]);

    // AngularJS controller
    app.controller('StudentController', function ($scope, $http) {
        $scope.student = {};
        $scope.loading = false;

        $scope.isFormInvalid = function () {
            return $scope.createStudentForm.$invalid || !$scope.student.PictureFile;
        };

        $scope.createStudent = function () {
            $scope.loading = true;
            var formData = new FormData();
            if ($scope.student.DateOfBirth) {
                $scope.student.DateOfBirth = new Date($scope.student.DateOfBirth).toISOString().split('T')[0];
            }
            for (const key in $scope.student) {
                formData.append(key, $scope.student[key]);
            }

            $http.post('/Students/Create', formData, {
                headers: { 'Content-Type': undefined }
            }).then(function (response) {
                $scope.loading = false;
                if (response.data.success) {
                    $scope.successMessage = 'Student created successfully!';
                    $scope.errorMessage = '';
                    setTimeout(() => window.location.href = '/Students/Index', 3000);
                } else {
                    $scope.errorMessage = response.data.message || 'An error occurred.';
                }
            }, function (error) {
                $scope.loading = false;
                $scope.errorMessage = 'An error occurred.';
            });
        };
    });
</script>
